<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>playground mk-1 · create loop play</title>
    <meta name="description" content="Web-based music creation tool. 8-track drum sequencer, synthesizer, 4-slot looper with mic input. By Nicolás Bronzina.">
    
    <!-- Favicon SVG -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%23f2f2f0'/%3E%3Ctext x='16' y='22' font-family='monospace' font-size='14' font-weight='600' text-anchor='middle' fill='%23000'%3Epg%3C/text%3E%3C/svg%3E">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://nicolasbronzina.com/playground-mk1-with-mic.html">
    <meta property="og:title" content="playground mk-1 · create loop play">
    <meta property="og:description" content="Web-based music creation tool. 8-track drum sequencer, synthesizer, 4-slot looper with mic input.">
    <meta property="og:image" content="https://nicolasbronzina.com/img/playground-og.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://nicolasbronzina.com/playground-mk1-with-mic.html">
    <meta name="twitter:title" content="playground mk-1 · create loop play">
    <meta name="twitter:description" content="Web-based music creation tool. 8-track drum sequencer, synthesizer, 4-slot looper with mic input.">
    <meta name="twitter:image" content="https://nicolasbronzina.com/img/playground-og.png">
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%23f2f2f0'/%3E%3Ctext x='90' y='120' font-family='monospace' font-size='80' font-weight='600' text-anchor='middle' fill='%23000'%3Epg%3C/text%3E%3C/svg%3E">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Light mode (default) */
            --bg-primary: #f2f2f0;
            --bg-secondary: #fefefe;
            --bg-tertiary: #fafafa;
            --bg-input: #0f0f0f;
            --border-primary: #e0e0e0;
            --border-secondary: #2a2a2a;
            --text-primary: #000;
            --text-secondary: #666;
            --text-tertiary: #999;
            --text-invert: #fff;
            --accent-primary: #000;
            --accent-secondary: #e0e0e0;
            --hover-primary: #f0f0f0;
            --hover-secondary: #ccc;
            --active-bg: #000;
            --active-text: #fff;
            --key-black: #000;
            --key-white: #fefefe;
            --step-playing: #666;
            --viz-bg: #fafafa;
            --viz-line: #000;
        }

        :root.dark-mode {
            /* Dark mode */
            --bg-primary: #0a0a0a;
            --bg-secondary: #141414;
            --bg-tertiary: #0f0f0f;
            --bg-input: #0f0f0f;
            --border-primary: #2a2a2a;
            --border-secondary: #444;
            --text-primary: #e0e0e0;
            --text-secondary: #999;
            --text-tertiary: #666;
            --text-invert: #000;
            --accent-primary: #e0e0e0;
            --accent-secondary: #2a2a2a;
            --hover-primary: #1a1a1a;
            --hover-secondary: #444;
            --active-bg: #e0e0e0;
            --active-text: #000;
            --key-black: #e0e0e0;
            --key-white: #1a1a1a;
            --step-playing: #999;
            --viz-bg: #0a0a0a;
            --viz-line: #e0e0e0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', 'Arial', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            position: relative;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }

        /* Film grain texture overlay - FIJO */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.25;
            z-index: 1;
            pointer-events: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400"><filter id="noise"><feTurbulence type="fractalNoise" baseFrequency="1.2" numOctaves="6" seed="2" /></filter><rect width="100%" height="100%" filter="url(%23noise)" opacity="1"/></svg>');
        }

        /* Subtle vignette */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            box-shadow: inset 0 0 200px rgba(0,0,0,0.12);
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-primary);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            overflow: hidden;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.12;
            z-index: 1;
            pointer-events: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="250" height="250"><filter id="hn"><feTurbulence type="fractalNoise" baseFrequency="1.1" numOctaves="4" /></filter><rect width="100%" height="100%" filter="url(%23hn)"/></svg>');
        }

        .brand {
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: lowercase;
            position: relative;
            z-index: 2;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 2rem;
        }

        .hero {
            text-align: center;
            margin-bottom: 2rem;
        }

        .hero h1 {
            font-size: 1.8rem;
            font-weight: 300;
            letter-spacing: -0.02em;
            margin-bottom: 0.5rem;
        }

        .hero p {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            font-weight: 300;
            transition: all 0.3s ease;
        }

        .hero .btn,
        .hero .btn-secondary {
            font-size: 0.7rem;
            padding: 0.8rem 1.5rem;
            width: 100%;
        }

        /* Grid Layout */
        .workspace {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .module {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            min-width: 0;
        }

        /* Grain texture on modules - FIJO */
        .module::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.12;
            z-index: 1;
            pointer-events: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="300"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="5" /></filter><rect width="100%" height="100%" filter="url(%23n)"/></svg>');
        }

        .module > * {
            position: relative;
            z-index: 2;
        }

        .module-full { grid-column: span 12; }
        .module-half { grid-column: span 6; }
        .module-third { grid-column: span 4; }
        .module-twothird { grid-column: span 8; }

        .module-header {
            margin-bottom: 0.8rem;
            padding-bottom: 0.5rem;
        }

        .module-title {
            font-size: 0.7rem;
            font-weight: 500;
            letter-spacing: 0.08em;
            text-transform: lowercase;
            color: var(--text-tertiary);
        }

        .module-desc {
            font-size: 0.65rem;
            font-weight: 400;
            color: #bbb;
            margin-top: 0.3rem;
            line-height: 1.4;
        }

        .module-label {
            font-size: 1.2rem;
            font-weight: 300;
            margin-top: 0.5rem;
        }

        /* Visualizer */
        .visualizer {
            height: 60px;
            background: var(--viz-bg);
            position: relative;
            overflow: hidden;
        }

        .visualizer::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.18;
            z-index: 10;
            pointer-events: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="350" height="350"><filter id="vn"><feTurbulence type="fractalNoise" baseFrequency="1.5" numOctaves="7" /></filter><rect width="100%" height="100%" filter="url(%23vn)"/></svg>');
        }

        canvas {
            width: 100%;
            height: 100%;
        }

        /* Pads */
        .pad-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .pad {
            aspect-ratio: 1;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .pad::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.15;
            z-index: 1;
            pointer-events: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><filter id="pn"><feTurbulence type="fractalNoise" baseFrequency="1.8" numOctaves="4" /></filter><rect width="100%" height="100%" filter="url(%23pn)"/></svg>');
        }

        .pad-label {
            font-size: 0.7rem;
            font-weight: 400;
            text-transform: lowercase;
            letter-spacing: 0.03em;
            color: var(--text-tertiary);
            position: relative;
            z-index: 2;
        }

        .pad-key {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 0.65rem;
            color: var(--text-tertiary);
            font-weight: 600;
            z-index: 2;
        }

        .pad:hover {
            background: var(--hover-primary);
            border-color: var(--border-secondary);
        }

        .pad.active {
            background: var(--active-bg);
            border-color: var(--active-bg);
        }

        .pad.active .pad-label {
            color: var(--active-text);
        }

        .pad.active .pad-key {
            color: var(--text-secondary);
        }

        /* Keyboard */
        .keyboard {
            display: flex;
            gap: 1px;
            height: 140px;
            background: var(--border-primary);
            padding: 1px;
            position: relative;
        }

        .key {
            flex: 1;
            background: var(--hover-primary);
            cursor: pointer;
            transition: all 0.05s ease;
            position: relative;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 1rem;
            user-select: none;
            -webkit-user-select: none;
        }

        .key-label {
            font-size: 0.65rem;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: lowercase;
        }

        .key.black {
            background: var(--active-bg);
            height: 90px;
            margin: 0 -12px;
            z-index: 2;
            flex: 0.6;
        }

        .key.black .key-label {
            color: var(--text-tertiary);
        }

        .key:active, .key.active {
            background: var(--border-primary);
        }

        .key.black:active, .key.black.active {
            background: var(--hover-secondary);
        }

        /* Controls */
        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.8rem;
            font-size: 0.7rem;
            font-weight: 400;
            text-transform: lowercase;
            letter-spacing: 0.03em;
            color: var(--text-tertiary);
        }

        .control-value {
            color: var(--text-primary);
            font-weight: 600;
            min-width: 50px;
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        input[type="range"] {
            width: 100%;
            height: 2px;
            background: var(--border-primary);
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--active-bg);
            border-radius: 50%;
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--active-bg);
            border-radius: 50%;
            border: none;
        }

        select {
            width: 100%;
            padding: 0.8rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%23999' stroke-width='1.5'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem;
        }

        select:focus {
            outline: none;
            border-color: var(--border-secondary);
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 1rem;
            background: var(--active-bg);
            border: none;
            color: var(--active-text);
            font-family: inherit;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: lowercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.15s ease;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .btn:hover {
            background: var(--hover-secondary);
        }

        .btn:active {
            background: var(--active-bg);
            transform: scale(0.98);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-secondary:hover {
            background: var(--hover-primary);
            border-color: var(--border-secondary);
        }

        .btn-secondary.active {
            background: var(--active-bg);
            color: var(--active-text);
            border-color: var(--text-primary);
        }

        .slot-btn {
            position: relative;
        }

        .slot-btn.has-content::after {
            content: '';
            position: absolute;
            top: 0.3rem;
            right: 0.3rem;
            width: 5px;
            height: 5px;
            background: #999;
            border-radius: 50%;
        }

        .slot-btn.has-content.active::after {
            background: #000;
        }

        .btn-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        /* Mic indicator */
        .mic-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            margin-right: 0.5rem;
            transition: all 0.3s ease;
        }

        .mic-indicator.active {
            background: #ff4444;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Sequencer */
        .sequencer {
            background: var(--viz-bg);
            padding: 0.8rem;
        }

        .seq-row {
            display: grid;
            grid-template-columns: 50px 1fr;
            gap: 6px;
            margin-bottom: 6px;
            align-items: center;
        }

        .seq-row:last-child {
            margin-bottom: 0;
        }

        .seq-label {
            font-size: 0.6rem;
            font-weight: 500;
            text-transform: lowercase;
            color: var(--text-tertiary);
            text-align: right;
            padding-right: 6px;
        }

        .seq-steps {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 2px;
        }

        .step {
            aspect-ratio: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            cursor: pointer;
            transition: all 0.1s ease;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .step:hover {
            background: var(--hover-primary);
        }

        .step.active {
            background: var(--active-bg);
            border-color: var(--text-primary);
        }

        .step.playing {
            background: #999;
            border-color: var(--text-tertiary);
        }

        /* Status Bar */
        .status-bar {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.7rem;
            font-weight: 400;
            text-transform: lowercase;
            letter-spacing: 0.03em;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .status-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.12;
            z-index: 1;
            pointer-events: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="250" height="250"><filter id="sn"><feTurbulence type="fractalNoise" baseFrequency="1.3" numOctaves="5" /></filter><rect width="100%" height="100%" filter="url(%23sn)"/></svg>');
        }

        .status-item {
            color: var(--text-tertiary);
            position: relative;
            z-index: 2;
        }

        .status-value {
            color: var(--text-primary);
            margin-left: 0.5rem;
        }

        /* Info */
        .info {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            padding: 2rem;
            margin-top: 3rem;
            position: relative;
            overflow: hidden;
        }

        .info::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.12;
            z-index: 1;
            pointer-events: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="300"><filter id="infon"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="5" /></filter><rect width="100%" height="100%" filter="url(%23infon)"/></svg>');
        }

        .info h3 {
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: lowercase;
            letter-spacing: 0.08em;
            color: var(--text-tertiary);
            margin-bottom: 1rem;
            position: relative;
            z-index: 2;
        }

        .shortcuts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            position: relative;
            z-index: 2;
        }

        .shortcut {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
        }

        .shortcut-key {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            padding: 0.3rem 0.6rem;
            font-weight: 500;
            min-width: 50px;
            text-align: center;
            font-size: 0.7rem;
            text-transform: lowercase;
        }

        .shortcut-desc {
            color: var(--text-tertiary);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .module-half, .module-third, .module-twothird {
                grid-column: span 12;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem 1.5rem;
            }

            .brand {
                font-size: 0.9rem;
            }

            .hero h1 {
                font-size: 1.5rem;
            }

            .hero p {
                font-size: 0.8rem;
            }

            .hero .btn,
            .hero .btn-secondary {
                font-size: 0.65rem;
                padding: 0.7rem 1.2rem;
            }

            .container {
                padding: 1.5rem 1rem;
            }

            .module {
                padding: 1rem;
            }

            .module-header {
                margin-bottom: 0.8rem;
                padding-bottom: 0.6rem;
            }

            .module-title {
                font-size: 0.65rem;
            }

            .module-desc {
                font-size: 0.6rem;
            }

            .workspace {
                gap: 1rem;
                margin-bottom: 1rem;
            }

            .pad-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 0.8rem;
            }

            .pad-label {
                font-size: 0.65rem;
            }

            .pad-key {
                font-size: 0.6rem;
                top: 0.4rem;
                right: 0.4rem;
            }

            .keyboard {
                height: 100px;
                overflow-x: auto;
                overflow-y: hidden;
                -webkit-overflow-scrolling: touch;
            }

            .key {
                min-width: 35px;
                padding-bottom: 0.8rem;
            }

            .key.black {
                height: 65px;
                min-width: 25px;
            }

            .key-label {
                font-size: 0.6rem;
            }

            .sequencer {
                padding: 0.6rem;
            }

            .seq-row {
                grid-template-columns: 40px 1fr;
                gap: 4px;
                margin-bottom: 4px;
            }

            .seq-label {
                font-size: 0.55rem;
                padding-right: 4px;
            }

            .seq-steps {
                gap: 1.5px;
            }

            .control-label {
                font-size: 0.65rem;
            }

            .control-group {
                margin-bottom: 1rem;
            }

            .btn, .btn-secondary {
                font-size: 0.7rem;
                padding: 0.8rem;
            }

            .btn-group {
                gap: 0.4rem;
            }

            select {
                font-size: 0.8rem;
                padding: 0.7rem 0.9rem;
            }

            .status-bar {
                padding: 0.8rem 1rem;
                font-size: 0.65rem;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .status-item {
                flex: 1 1 45%;
            }

            .visualizer {
                height: 50px !important;
            }

            .info {
                padding: 1.5rem;
            }

            .shortcuts-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 0.8rem;
            }

            .shortcut {
                font-size: 0.8rem;
            }

            .shortcut-key {
                font-size: 0.65rem;
                padding: 0.25rem 0.5rem;
                min-width: 45px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 0.8rem 1rem;
            }

            .brand {
                font-size: 0.8rem;
            }

            .hero h1 {
                font-size: 1.3rem;
            }

            .hero p {
                font-size: 0.75rem;
            }

            .hero .btn,
            .hero .btn-secondary {
                font-size: 0.6rem;
                padding: 0.65rem 1rem;
            }

            .container {
                padding: 1rem 0.8rem;
            }

            .module {
                padding: 0.8rem;
            }

            .pad-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.6rem;
            }

            .keyboard {
                height: 90px;
            }

            .key {
                min-width: 30px;
            }

            .key.black {
                height: 60px;
                min-width: 20px;
            }

            .seq-row {
                grid-template-columns: 35px 1fr;
            }

            .seq-label {
                font-size: 0.5rem;
            }

            .status-bar {
                padding: 0.7rem 0.8rem;
                font-size: 0.6rem;
            }

            .module .btn-group {
                grid-template-columns: repeat(2, 1fr);
            }

            .slot-btn {
                font-size: 0.65rem;
            }

            .shortcuts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (min-width: 768px) and (max-width: 1024px) {
            .container {
                padding: 2rem 1.5rem;
            }

            .module-half {
                grid-column: span 6;
            }

            .workspace:first-of-type .module-twothird {
                grid-column: span 8;
            }

            .workspace:first-of-type .module-third {
                grid-column: span 4;
            }
        }

        @media (hover: none) and (pointer: coarse) {
            .pad, .key, .step, .btn, .btn-secondary, .slot-btn {
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }

            .pad {
                min-height: 60px;
            }

            .step {
                min-height: 20px;
            }

            input[type="range"] {
                height: 30px;
                padding: 10px 0;
            }

            input[type="range"]::-webkit-slider-thumb {
                width: 20px;
                height: 20px;
            }

            input[type="range"]::-moz-range-thumb {
                width: 20px;
                height: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <div class="brand">playground mk-1</div>
            <div style="font-size: 0.7rem; color: var(--text-tertiary); font-weight: 400; margin-top: 0.3rem;" id="timestamp"></div>
        </div>
        <button id="themeToggle" style="background: none; border: 1px solid var(--border-primary); color: var(--text-primary); padding: 0.5rem 0.8rem; cursor: pointer; font-size: 0.7rem; font-weight: 500; text-transform: lowercase; letter-spacing: 0.05em; transition: all 0.15s ease;">
            <span id="themeIcon">◐</span>
        </button>
    </div>

    <div class="container">
        <div class="hero">
            <h1>create · loop · play</h1>
            <p>try the demo or just start creating</p>
            <div style="display: flex; gap: 0.5rem; justify-content: center; margin-top: 1rem;">
                <button class="btn" id="loadDemoBtn" style="max-width: 150px;">load demo</button>
                <button class="btn-secondary" id="clearAllBtn" style="max-width: 150px; padding: 0.8rem 1.5rem; font-size: 0.7rem;">clear all</button>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-item"><span class="status-value" id="sysStatus">ready</span></div>
            <div class="status-item">rec: <span class="status-value" id="recStatus">off</span></div>
            <div class="status-item"><span class="status-value" id="tempoStatus">120</span> bpm</div>
            <div class="status-item">patterns: <span class="status-value" id="patternCount">0</span></div>
        </div>

        <!-- Visualizer -->
        <div class="workspace">
            <div class="module module-full">
                <div class="module-header">
                    <div class="module-title">wave</div>
                    <div class="module-desc">visual audio feedback</div>
                </div>
                <div class="visualizer" style="height: 60px;">
                    <canvas id="viz"></canvas>
                </div>
            </div>
        </div>

        <!-- Main Grid - Drums + Pattern -->
        <div class="workspace">
            <div class="module module-twothird">
                <div class="module-header">
                    <div class="module-title">drums</div>
                    <div class="module-desc">tap pads or use keys 1-8 to play sounds</div>
                </div>
                <div class="pad-grid">
                    <div class="pad" data-sound="kick">
                        <span class="pad-key">1</span>
                        <span class="pad-label">kick</span>
                    </div>
                    <div class="pad" data-sound="snare">
                        <span class="pad-key">2</span>
                        <span class="pad-label">snare</span>
                    </div>
                    <div class="pad" data-sound="hihat">
                        <span class="pad-key">3</span>
                        <span class="pad-label">hat</span>
                    </div>
                    <div class="pad" data-sound="clap">
                        <span class="pad-key">4</span>
                        <span class="pad-label">clap</span>
                    </div>
                    <div class="pad" data-sound="tom1">
                        <span class="pad-key">5</span>
                        <span class="pad-label">tom</span>
                    </div>
                    <div class="pad" data-sound="perc">
                        <span class="pad-key">6</span>
                        <span class="pad-label">perc</span>
                    </div>
                    <div class="pad" data-sound="cymbal">
                        <span class="pad-key">7</span>
                        <span class="pad-label">cymbal</span>
                    </div>
                    <div class="pad" data-sound="rim">
                        <span class="pad-key">8</span>
                        <span class="pad-label">rim</span>
                    </div>
                </div>
            </div>

            <div class="module module-third">
                <div class="module-header">
                    <div class="module-title">pattern</div>
                    <div class="module-desc">program rhythms · play auto-records</div>
                </div>
                <div id="sequencer">
                    <div class="seq-row">
                        <div class="seq-label">kick</div>
                        <div class="seq-steps" data-drum="kick"></div>
                    </div>
                    <div class="seq-row">
                        <div class="seq-label">snare</div>
                        <div class="seq-steps" data-drum="snare"></div>
                    </div>
                    <div class="seq-row">
                        <div class="seq-label">hihat</div>
                        <div class="seq-steps" data-drum="hihat"></div>
                    </div>
                    <div class="seq-row">
                        <div class="seq-label">clap</div>
                        <div class="seq-steps" data-drum="clap"></div>
                    </div>
                    <div class="seq-row">
                        <div class="seq-label">tom</div>
                        <div class="seq-steps" data-drum="tom1"></div>
                    </div>
                    <div class="seq-row">
                        <div class="seq-label">perc</div>
                        <div class="seq-steps" data-drum="perc"></div>
                    </div>
                    <div class="seq-row">
                        <div class="seq-label">cymbal</div>
                        <div class="seq-steps" data-drum="cymbal"></div>
                    </div>
                    <div class="seq-row">
                        <div class="seq-label">rim</div>
                        <div class="seq-steps" data-drum="rim"></div>
                    </div>
                </div>
                <div class="btn-group" style="margin-top: 1rem;">
                    <button class="btn-secondary" id="playSeq">play+rec</button>
                    <button class="btn-secondary" id="clearSeq">clear</button>
                </div>
            </div>
        </div>

        <!-- Keys -->
        <div class="workspace">
            <div class="module module-full">
                <div class="module-header">
                    <div class="module-title">keys</div>
                    <div class="module-desc">play melodies with a-k keys</div>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <div class="control-label" style="margin-bottom: 0.5rem;">
                        <span>wave</span>
                    </div>
                    <select id="waveType">
                        <option value="sine">sine</option>
                        <option value="square">square</option>
                        <option value="sawtooth">saw</option>
                        <option value="triangle">triangle</option>
                    </select>
                </div>

                <div class="keyboard">
                    <div class="key" data-note="C4"><span class="key-label">a · c4</span></div>
                    <div class="key black" data-note="C#4"><span class="key-label">w</span></div>
                    <div class="key" data-note="D4"><span class="key-label">s · d4</span></div>
                    <div class="key black" data-note="D#4"><span class="key-label">e</span></div>
                    <div class="key" data-note="E4"><span class="key-label">d · e4</span></div>
                    <div class="key" data-note="F4"><span class="key-label">f · f4</span></div>
                    <div class="key black" data-note="F#4"><span class="key-label">t</span></div>
                    <div class="key" data-note="G4"><span class="key-label">g · g4</span></div>
                    <div class="key black" data-note="G#4"><span class="key-label">y</span></div>
                    <div class="key" data-note="A4"><span class="key-label">h · a4</span></div>
                    <div class="key black" data-note="A#4"><span class="key-label">u</span></div>
                    <div class="key" data-note="B4"><span class="key-label">j · b4</span></div>
                    <div class="key" data-note="C5"><span class="key-label">k · c5</span></div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
                    <div class="control-group">
                        <div class="control-label">
                            <span>attack</span>
                            <span class="control-value" id="attackVal">10ms</span>
                        </div>
                        <input type="range" id="attack" min="0" max="500" value="10">
                    </div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>release</span>
                            <span class="control-value" id="releaseVal">300ms</span>
                        </div>
                        <input type="range" id="release" min="0" max="2000" value="300">
                    </div>
                </div>
            </div>
        </div>

        <!-- Vibe + FX/Tempo + Loop -->
        <div class="workspace">
            <div class="module module-third">
                <div class="module-header">
                    <div class="module-title">vibe</div>
                    <div class="module-desc">your music companion</div>
                </div>
                <div style="display: flex; align-items: center; justify-content: center; min-height: 280px;">
                    <svg id="vibeCircle" width="200" height="200" viewBox="0 0 200 200" style="max-width: 100%; cursor: pointer;">
                        <circle id="vibeCircleMain" cx="100" cy="100" r="80" fill="none" stroke="var(--text-primary)" stroke-width="2"/>
                        <circle id="vibeEyeLeft" cx="75" cy="85" r="4" fill="var(--text-primary)"/>
                        <circle id="vibeEyeRight" cx="125" cy="85" r="4" fill="var(--text-primary)"/>
                        <path id="vibeMouth" d="M 70 115 Q 100 125 130 115" fill="none" stroke="var(--text-primary)" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </div>
            </div>

            <div class="module module-third">
                <div class="module-header">
                    <div class="module-title">fx + tempo</div>
                    <div class="module-desc">shape your sound</div>
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>tempo</span>
                        <span class="control-value" id="tempoVal">120</span>
                    </div>
                    <input type="range" id="tempo" min="60" max="200" value="120">
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>reverb</span>
                        <span class="control-value" id="reverbVal">0%</span>
                    </div>
                    <input type="range" id="reverb" min="0" max="100" value="0">
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>delay</span>
                        <span class="control-value" id="delayVal">0%</span>
                    </div>
                    <input type="range" id="delay" min="0" max="100" value="0">
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>filter</span>
                        <span class="control-value" id="filterVal">10000Hz</span>
                    </div>
                    <input type="range" id="filter" min="100" max="10000" value="10000">
                </div>
            </div>

            <div class="module module-third">
                <div class="module-header">
                    <div class="module-title">loop</div>
                    <div class="module-desc">record & layer up to 4 loops + mic input</div>
                </div>
                
                <div class="btn-group" style="margin-bottom: 1rem;">
                    <button class="btn-secondary slot-btn active" data-slot="A">A</button>
                    <button class="btn-secondary slot-btn" data-slot="B">B</button>
                    <button class="btn-secondary slot-btn" data-slot="C">C</button>
                    <button class="btn-secondary slot-btn" data-slot="D">D</button>
                </div>
                
                <button class="btn-secondary" id="micBtn" style="margin-bottom: 1rem;">
                    <span class="mic-indicator" id="micIndicator"></span>mic
                </button>
                
                <div style="text-align: center; margin-bottom: 1rem; min-height: 1.2rem;">
                    <span style="font-size: 0.65rem; color: var(--text-tertiary);" id="slotInfo">slot A · empty</span>
                </div>
                
                <button class="btn-secondary" id="recordBtn">rec manual</button>
                <button class="btn-secondary" id="overdubBtn" style="margin-top: 0.5rem;">add layer</button>
                <button class="btn-secondary" id="playLoopBtn" style="margin-top: 0.5rem;">play</button>
                <button class="btn-secondary" id="playAllBtn" style="margin-top: 0.5rem;">play all</button>
                <button class="btn-secondary" id="clearLoopBtn" style="margin-top: 0.5rem;">clear</button>
                <button class="btn" id="downloadBtn" style="margin-top: 0.5rem; display: none;">download</button>
                
                <div class="control-group" style="margin-top: 1.5rem;">
                    <div class="control-label">
                        <span>volume</span>
                        <span class="control-value" id="masterVolVal">70%</span>
                    </div>
                    <input type="range" id="masterVol" min="0" max="100" value="70">
                </div>
                <button class="btn" id="initBtn" style="margin-top: 1rem;">start</button>
            </div>
        </div>

        <!-- Info -->
        <div class="info">
            <h3>keys</h3>
            <div class="shortcuts-grid">
                <div class="shortcut">
                    <span class="shortcut-key">1-8</span>
                    <span class="shortcut-desc">drums</span>
                </div>
                <div class="shortcut">
                    <span class="shortcut-key">a-k</span>
                    <span class="shortcut-desc">notes</span>
                </div>
                <div class="shortcut">
                    <span class="shortcut-key">space</span>
                    <span class="shortcut-desc">play+rec</span>
                </div>
                <div class="shortcut">
                    <span class="shortcut-key">enter</span>
                    <span class="shortcut-desc">start</span>
                </div>
                <div class="shortcut">
                    <span class="shortcut-key">load demo</span>
                    <span class="shortcut-desc">example track</span>
                </div>
                <div class="shortcut">
                    <span class="shortcut-key">clear all</span>
                    <span class="shortcut-desc">reset everything</span>
                </div>
                <div class="shortcut">
                    <span class="shortcut-key">r</span>
                    <span class="shortcut-desc">rec manual</span>
                </div>
                <div class="shortcut">
                    <span class="shortcut-key">o</span>
                    <span class="shortcut-desc">add layer</span>
                </div>
                <div class="shortcut">
                    <span class="shortcut-key">p</span>
                    <span class="shortcut-desc">play loop</span>
                </div>
                <div class="shortcut">
                    <span class="shortcut-key">l</span>
                    <span class="shortcut-desc">play all</span>
                </div>
                <div class="shortcut">
                    <span class="shortcut-key">c</span>
                    <span class="shortcut-desc">clear loop</span>
                </div>
                <div class="shortcut">
                    <span class="shortcut-key">v</span>
                    <span class="shortcut-desc">download</span>
                </div>
                <div class="shortcut">
                    <span class="shortcut-key">x</span>
                    <span class="shortcut-desc">clear pattern</span>
                </div>
                <div class="shortcut">
                    <span class="shortcut-key">q/z/b/n</span>
                    <span class="shortcut-desc">slots A/B/C/D</span>
                </div>
                <div class="shortcut">
                    <span class="shortcut-key">m</span>
                    <span class="shortcut-desc">toggle mic</span>
                </div>
            </div>
        </div>

<!-- Credit + Support -->
<div style="text-align: center; padding: 2rem; font-size: 0.7rem; color: var(--text-tertiary);">
    <div style="margin-bottom: 0.8rem;">
        designed, coded & built by <a href="https://nicolasbronzina.com" target="_blank" style="color: var(--text-tertiary); text-decoration: none; border-bottom: 1px solid var(--border-secondary);">nicolás bronzina</a>
    </div>
    <div>
        <a href="https://buymeacoffee.com/nbronzina" target="_blank" style="color: var(--text-tertiary); text-decoration: none; border-bottom: 1px solid var(--border-secondary); transition: all 0.3s ease;">support playground</a>
    </div>
</div>

    <script>
        // Audio Engine
        let audioContext;
        let masterGain;
        let analyser;
        let isActive = false;
        
        let micStream = null;
        let micSource = null;
        let micGain = null;
        let isMicActive = false;
        
        let loopSlots = {
            A: { loop: [], audioBlob: null, audioBuffer: null, duration: 0, isPlaying: false },
            B: { loop: [], audioBlob: null, audioBuffer: null, duration: 0, isPlaying: false },
            C: { loop: [], audioBlob: null, audioBuffer: null, duration: 0, isPlaying: false },
            D: { loop: [], audioBlob: null, audioBuffer: null, duration: 0, isPlaying: false }
        };
        let activeSlot = 'A';
        let isRecording = false;
        let recordingStart = 0;
        let isOverdub = false;
        
        let mediaRecorder;
        let audioChunks = [];
        let mediaStreamDestination;
        
        let sequencerSteps = {
            kick: Array(16).fill(false),
            snare: Array(16).fill(false),
            hihat: Array(16).fill(false),
            clap: Array(16).fill(false),
            tom1: Array(16).fill(false),
            perc: Array(16).fill(false),
            cymbal: Array(16).fill(false),
            rim: Array(16).fill(false)
        };
        let currentStep = 0;
        let isPlaying = false;
        let sequencerInterval;
        
        let attackTime = 10;
        let releaseTime = 300;
        
        const canvas = document.getElementById('viz');
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        
        const notes = {
            'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13,
            'E4': 329.63, 'F4': 349.23, 'F#4': 369.99, 'G4': 392.00,
            'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88,
            'C5': 523.25
        };

        // Vibe Circle Animation
        let vibeCircle = document.getElementById('vibeCircleMain');
        let vibeEyeLeft = document.getElementById('vibeEyeLeft');
        let vibeEyeRight = document.getElementById('vibeEyeRight');
        let vibeMouth = document.getElementById('vibeMouth');
        let vibeBaseRadius = 80;
        let vibeCurrentScale = 1;
        let vibeTargetScale = 1;
        let vibeMouthState = 'neutral'; // neutral, happy, excited
        let vibeIsDoingTrick = false; // Flag to pause audio reactions during tricks
        let lastVibeExpression = null; // Track last expression to avoid repeats

        // Click reactions - abstract/experimental expressions
        const vibeExpressions = [
            {
                name: 'glitch',
                eyes: () => {
                    vibeEyeLeft.setAttribute('cx', '65');
                    vibeEyeLeft.setAttribute('cy', '75');
                    vibeEyeRight.setAttribute('cx', '135');
                    vibeEyeRight.setAttribute('cy', '95');
                    vibeEyeLeft.setAttribute('r', '2');
                    vibeEyeRight.setAttribute('r', '6');
                },
                mouth: 'M 60 115 L 70 120 L 80 115 L 90 125 L 100 115 L 110 120 L 120 115 L 130 125 L 140 115' // Glitchy zigzag
            },
            {
                name: 'melt',
                eyes: () => {
                    vibeEyeLeft.setAttribute('cy', '95');
                    vibeEyeRight.setAttribute('cy', '95');
                    vibeEyeLeft.setAttribute('ry', '8');
                    vibeEyeRight.setAttribute('ry', '8');
                    vibeEyeLeft.setAttribute('r', '3');
                    vibeEyeRight.setAttribute('r', '3');
                },
                mouth: 'M 70 130 Q 100 135 130 130' // Melting down
            },
            {
                name: 'zen',
                eyes: () => {
                    vibeEyeLeft.setAttribute('r', '1');
                    vibeEyeRight.setAttribute('r', '1');
                },
                mouth: 'M 80 115 L 120 115' // Flat line
            },
            {
                name: 'vibrate',
                eyes: () => {
                    vibeEyeLeft.setAttribute('cx', '73');
                    vibeEyeLeft.setAttribute('cy', '83');
                    vibeEyeRight.setAttribute('cx', '127');
                    vibeEyeRight.setAttribute('cy', '87');
                    vibeEyeLeft.setAttribute('r', '5');
                    vibeEyeRight.setAttribute('r', '5');
                },
                mouth: 'M 68 115 Q 75 120 82 115 Q 90 110 98 115 Q 106 120 114 115 Q 122 110 130 115' // Wavy energy
            },
            {
                name: 'flip',
                eyes: () => {
                    vibeEyeLeft.setAttribute('cy', '115');
                    vibeEyeRight.setAttribute('cy', '115');
                    vibeEyeLeft.setAttribute('r', '4');
                    vibeEyeRight.setAttribute('r', '4');
                },
                mouth: 'M 70 85 Q 100 75 130 85' // Upside down
            },
            {
                name: 'spiral',
                eyes: () => {
                    vibeEyeLeft.setAttribute('cx', '70');
                    vibeEyeLeft.setAttribute('cy', '80');
                    vibeEyeRight.setAttribute('cx', '130');
                    vibeEyeRight.setAttribute('cy', '90');
                    vibeEyeLeft.setAttribute('r', '2');
                    vibeEyeRight.setAttribute('r', '7');
                },
                mouth: 'M 100 115 Q 110 120 115 115 Q 118 108 112 105' // Swirl
            }
        ];

        function doRandomVibeTrick() {
            if (vibeIsDoingTrick) return; // Don't interrupt current trick
            
            vibeIsDoingTrick = true;
            
            // Filter out last expression to avoid repeats
            let availableExpressions = vibeExpressions;
            if (lastVibeExpression !== null) {
                availableExpressions = vibeExpressions.filter((expr, index) => index !== lastVibeExpression);
            }
            
            // Pick random expression from available ones
            const randomIndex = Math.floor(Math.random() * availableExpressions.length);
            const expression = availableExpressions[randomIndex];
            
            // Remember this expression to avoid repeating it next time
            lastVibeExpression = vibeExpressions.indexOf(expression);
            
            // Apply expression
            expression.eyes();
            vibeMouth.setAttribute('d', expression.mouth);
            
            // Return to normal after 2 seconds
            setTimeout(() => {
                vibeIsDoingTrick = false;
                // Reset to default positions
                vibeEyeLeft.setAttribute('cx', '75');
                vibeEyeLeft.setAttribute('cy', '85');
                vibeEyeLeft.setAttribute('r', '4');
                vibeEyeLeft.setAttribute('ry', '4');
                vibeEyeRight.setAttribute('cx', '125');
                vibeEyeRight.setAttribute('cy', '85');
                vibeEyeRight.setAttribute('r', '4');
                vibeEyeRight.setAttribute('ry', '4');
                vibeMouth.setAttribute('d', 'M 70 115 Q 100 125 130 115');
            }, 2000);
        }

        // Add click listener to vibe circle
        document.getElementById('vibeCircle').addEventListener('click', doRandomVibeTrick);

        function animateVibe() {
            requestAnimationFrame(animateVibe);
            
            // Don't animate if user is doing a trick
            if (vibeIsDoingTrick) {
                return;
            }
            
            if (!isActive || !analyser) {
                // Sleeping state - closed eyes
                vibeEyeLeft.setAttribute('ry', '1');
                vibeEyeRight.setAttribute('ry', '1');
                vibeCurrentScale = 1;
                vibeCircle.setAttribute('r', vibeBaseRadius);
                vibeMouth.setAttribute('d', 'M 75 115 Q 100 118 125 115');
                return;
            }
            
            // Get audio data
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);
            
            // Calculate average volume
            let sum = 0;
            for (let i = 0; i < bufferLength; i++) {
                sum += dataArray[i];
            }
            const average = sum / bufferLength;
            const normalizedVolume = average / 255; // 0 to 1
            
            // Animate based on volume
            if (normalizedVolume > 0.02) { // Active sound
                // Open eyes
                vibeEyeLeft.setAttribute('ry', '4');
                vibeEyeRight.setAttribute('ry', '4');
                
                // Scale circle based on volume
                vibeTargetScale = 1 + (normalizedVolume * 0.15);
                
                // Change mouth expression
                if (normalizedVolume > 0.15) {
                    // Excited
                    vibeMouth.setAttribute('d', 'M 70 110 Q 100 130 130 110');
                } else if (normalizedVolume > 0.05) {
                    // Happy
                    vibeMouth.setAttribute('d', 'M 70 115 Q 100 125 130 115');
                } else {
                    // Subtle smile
                    vibeMouth.setAttribute('d', 'M 75 115 Q 100 120 125 115');
                }
                
                // Blink occasionally when excited
                if (normalizedVolume > 0.2 && Math.random() > 0.98) {
                    vibeEyeLeft.setAttribute('ry', '1');
                    vibeEyeRight.setAttribute('ry', '1');
                    setTimeout(() => {
                        vibeEyeLeft.setAttribute('ry', '4');
                        vibeEyeRight.setAttribute('ry', '4');
                    }, 100);
                }
            } else {
                // Idle state
                vibeEyeLeft.setAttribute('ry', '4');
                vibeEyeRight.setAttribute('ry', '4');
                vibeTargetScale = 1;
                vibeMouth.setAttribute('d', 'M 75 115 Q 100 118 125 115');
            }
            
            // Smooth scaling
            vibeCurrentScale += (vibeTargetScale - vibeCurrentScale) * 0.15;
            const newRadius = vibeBaseRadius * vibeCurrentScale;
            vibeCircle.setAttribute('r', newRadius);
        }

        // Start vibe animation
        animateVibe();

        function initSystem() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                masterGain = audioContext.createGain();
                masterGain.gain.value = 0.7;
                
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                
                const delayNode = audioContext.createDelay();
                delayNode.delayTime.value = 0.3;
                const delayFeedback = audioContext.createGain();
                delayFeedback.gain.value = 0.3;
                const delayMix = audioContext.createGain();
                delayMix.gain.value = 0;
                
                delayNode.connect(delayFeedback);
                delayFeedback.connect(delayNode);
                delayNode.connect(delayMix);
                
                const reverbNode = audioContext.createConvolver();
                const reverbMix = audioContext.createGain();
                reverbMix.gain.value = 0;
                
                const reverbTime = 2;
                const sampleRate = audioContext.sampleRate;
                const length = sampleRate * reverbTime;
                const impulse = audioContext.createBuffer(2, length, sampleRate);
                const impulseL = impulse.getChannelData(0);
                const impulseR = impulse.getChannelData(1);
                
                for (let i = 0; i < length; i++) {
                    const decay = Math.pow(1 - i / length, 2);
                    impulseL[i] = (Math.random() * 2 - 1) * decay;
                    impulseR[i] = (Math.random() * 2 - 1) * decay;
                }
                reverbNode.buffer = impulse;
                reverbNode.connect(reverbMix);
                
                const filterNode = audioContext.createBiquadFilter();
                filterNode.type = 'lowpass';
                filterNode.frequency.value = 10000;
                filterNode.Q.value = 1;
                
                masterGain.connect(delayNode);
                masterGain.connect(reverbNode);
                masterGain.connect(filterNode);
                delayMix.connect(filterNode);
                reverbMix.connect(filterNode);
                filterNode.connect(analyser);
                analyser.connect(audioContext.destination);
                
                window.delayMix = delayMix;
                window.reverbMix = reverbMix;
                window.filterNode = filterNode;
                
                mediaStreamDestination = audioContext.createMediaStreamDestination();
                analyser.connect(mediaStreamDestination);
                
                isActive = true;
                document.getElementById('sysStatus').textContent = 'active';
                document.getElementById('initBtn').textContent = 'active';
                document.getElementById('initBtn').classList.add('active');
                
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                drawViz();
            } else if (audioContext.state === 'suspended') {
                audioContext.resume();
                isActive = true;
                document.getElementById('sysStatus').textContent = 'active';
            }
        }

        async function toggleMic() {
            if (!audioContext) {
                initSystem();
                setTimeout(toggleMic, 100);
                return;
            }
            
            if (!isMicActive) {
                try {
                    micStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false
                        } 
                    });
                    
                    micSource = audioContext.createMediaStreamSource(micStream);
                    micGain = audioContext.createGain();
                    micGain.gain.value = 1.0;
                    micSource.connect(micGain);
                    micGain.connect(masterGain);
                    
                    isMicActive = true;
                    document.getElementById('micBtn').classList.add('active');
                    document.getElementById('micIndicator').classList.add('active');
                    
                    const heroP = document.querySelector('.hero p');
                    const originalText = heroP.textContent;
                    heroP.textContent = 'mic active · ready to capture external audio';
                    setTimeout(() => {
                        heroP.textContent = originalText;
                    }, 3000);
                    
                } catch (error) {
                    console.error('Microphone access denied:', error);
                    alert('Could not access microphone. Please check permissions.');
                }
            } else {
                if (micSource) {
                    micSource.disconnect();
                    micSource = null;
                }
                if (micGain) {
                    micGain.disconnect();
                    micGain = null;
                }
                if (micStream) {
                    micStream.getTracks().forEach(track => track.stop());
                    micStream = null;
                }
                
                isMicActive = false;
                document.getElementById('micBtn').classList.remove('active');
                document.getElementById('micIndicator').classList.remove('active');
                
                const heroP = document.querySelector('.hero p');
                const originalText = heroP.textContent;
                heroP.textContent = 'mic off';
                setTimeout(() => {
                    heroP.textContent = originalText;
                }, 2000);
            }
        }

        function playDrum(type, skipRecording = false) {
            if (!audioContext) {
                initSystem();
                setTimeout(() => playDrum(type), 100);
                return;
            }
            
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            const pad = document.querySelector(`[data-sound="${type}"]`);
            if (pad) {
                pad.classList.add('active');
                setTimeout(() => pad.classList.remove('active'), 150);
            }
            
            const now = audioContext.currentTime;
            
            switch(type) {
                case 'kick':
                    const kickOsc = audioContext.createOscillator();
                    const kickGain = audioContext.createGain();
                    const kickFilter = audioContext.createBiquadFilter();
                    
                    kickOsc.type = 'sine';
                    kickOsc.frequency.setValueAtTime(150, now);
                    kickOsc.frequency.exponentialRampToValueAtTime(40, now + 0.05);
                    kickOsc.frequency.exponentialRampToValueAtTime(20, now + 0.5);
                    
                    kickFilter.type = 'lowpass';
                    kickFilter.frequency.value = 200;
                    kickFilter.Q.value = 1;
                    
                    kickGain.gain.setValueAtTime(1.5, now);
                    kickGain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                    
                    kickOsc.connect(kickFilter);
                    kickFilter.connect(kickGain);
                    kickGain.connect(masterGain);
                    
                    kickOsc.start(now);
                    kickOsc.stop(now + 0.5);
                    break;
                    
                case 'snare':
                    const snareOsc = audioContext.createOscillator();
                    const snareNoise = audioContext.createBufferSource();
                    const snareNoiseFilter = audioContext.createBiquadFilter();
                    const snareGain = audioContext.createGain();
                    const snareNoiseGain = audioContext.createGain();
                    
                    snareOsc.type = 'triangle';
                    snareOsc.frequency.value = 180;
                    
                    const noiseBuffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.2, audioContext.sampleRate);
                    const noiseData = noiseBuffer.getChannelData(0);
                    for (let i = 0; i < noiseBuffer.length; i++) {
                        noiseData[i] = Math.random() * 2 - 1;
                    }
                    snareNoise.buffer = noiseBuffer;
                    
                    snareNoiseFilter.type = 'highpass';
                    snareNoiseFilter.frequency.value = 1000;
                    
                    snareGain.gain.setValueAtTime(0.4, now);
                    snareGain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                    
                    snareNoiseGain.gain.setValueAtTime(0.8, now);
                    snareNoiseGain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                    
                    snareOsc.connect(snareGain);
                    snareNoise.connect(snareNoiseFilter);
                    snareNoiseFilter.connect(snareNoiseGain);
                    snareGain.connect(masterGain);
                    snareNoiseGain.connect(masterGain);
                    
                    snareOsc.start(now);
                    snareOsc.stop(now + 0.2);
                    snareNoise.start(now);
                    snareNoise.stop(now + 0.15);
                    break;
                    
                case 'hihat':
                    const hihatNoise = audioContext.createBufferSource();
                    const hihatFilter = audioContext.createBiquadFilter();
                    const hihatGain = audioContext.createGain();
                    
                    const hihatBuffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.1, audioContext.sampleRate);
                    const hihatData = hihatBuffer.getChannelData(0);
                    for (let i = 0; i < hihatBuffer.length; i++) {
                        hihatData[i] = Math.random() * 2 - 1;
                    }
                    hihatNoise.buffer = hihatBuffer;
                    
                    hihatFilter.type = 'highpass';
                    hihatFilter.frequency.value = 7000;
                    hihatFilter.Q.value = 1;
                    
                    hihatGain.gain.setValueAtTime(0.3, now);
                    hihatGain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                    
                    hihatNoise.connect(hihatFilter);
                    hihatFilter.connect(hihatGain);
                    hihatGain.connect(masterGain);
                    
                    hihatNoise.start(now);
                    break;
                    
                case 'clap':
                    for (let i = 0; i < 3; i++) {
                        const clapNoise = audioContext.createBufferSource();
                        const clapFilter = audioContext.createBiquadFilter();
                        const clapGain = audioContext.createGain();
                        
                        const clapBuffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.05, audioContext.sampleRate);
                        const clapData = clapBuffer.getChannelData(0);
                        for (let j = 0; j < clapBuffer.length; j++) {
                            clapData[j] = Math.random() * 2 - 1;
                        }
                        clapNoise.buffer = clapBuffer;
                        
                        clapFilter.type = 'bandpass';
                        clapFilter.frequency.value = 1000;
                        clapFilter.Q.value = 5;
                        
                        const delay = i * 0.015;
                        clapGain.gain.setValueAtTime(0.5, now + delay);
                        clapGain.gain.exponentialRampToValueAtTime(0.01, now + delay + 0.05);
                        
                        clapNoise.connect(clapFilter);
                        clapFilter.connect(clapGain);
                        clapGain.connect(masterGain);
                        
                        clapNoise.start(now + delay);
                    }
                    break;
                    
                case 'tom1':
                    const tomOsc = audioContext.createOscillator();
                    const tomGain = audioContext.createGain();
                    const tomFilter = audioContext.createBiquadFilter();
                    
                    tomOsc.type = 'sine';
                    tomOsc.frequency.setValueAtTime(220, now);
                    tomOsc.frequency.exponentialRampToValueAtTime(150, now + 0.1);
                    
                    tomFilter.type = 'lowpass';
                    tomFilter.frequency.value = 800;
                    tomFilter.Q.value = 8;
                    
                    tomGain.gain.setValueAtTime(1.0, now);
                    tomGain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                    
                    tomOsc.connect(tomFilter);
                    tomFilter.connect(tomGain);
                    tomGain.connect(masterGain);
                    
                    tomOsc.start(now);
                    tomOsc.stop(now + 0.4);
                    break;
                    
                case 'perc':
                    const percOsc1 = audioContext.createOscillator();
                    const percOsc2 = audioContext.createOscillator();
                    const percGain = audioContext.createGain();
                    
                    percOsc1.type = 'square';
                    percOsc1.frequency.value = 800;
                    percOsc2.type = 'square';
                    percOsc2.frequency.value = 540;
                    
                    percGain.gain.setValueAtTime(0.3, now);
                    percGain.gain.exponentialRampToValueAtTime(0.01, now + 0.08);
                    
                    percOsc1.connect(percGain);
                    percOsc2.connect(percGain);
                    percGain.connect(masterGain);
                    
                    percOsc1.start(now);
                    percOsc2.start(now);
                    percOsc1.stop(now + 0.08);
                    percOsc2.stop(now + 0.08);
                    break;
                    
                case 'cymbal':
                    const cymbalNoise = audioContext.createBufferSource();
                    const cymbalFilter1 = audioContext.createBiquadFilter();
                    const cymbalFilter2 = audioContext.createBiquadFilter();
                    const cymbalGain = audioContext.createGain();
                    
                    const cymbalBuffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.8, audioContext.sampleRate);
                    const cymbalData = cymbalBuffer.getChannelData(0);
                    for (let i = 0; i < cymbalBuffer.length; i++) {
                        cymbalData[i] = Math.random() * 2 - 1;
                    }
                    cymbalNoise.buffer = cymbalBuffer;
                    
                    cymbalFilter1.type = 'highpass';
                    cymbalFilter1.frequency.value = 5000;
                    cymbalFilter2.type = 'bandpass';
                    cymbalFilter2.frequency.value = 8000;
                    cymbalFilter2.Q.value = 2;
                    
                    cymbalGain.gain.setValueAtTime(0.3, now);
                    cymbalGain.gain.exponentialRampToValueAtTime(0.01, now + 0.8);
                    
                    cymbalNoise.connect(cymbalFilter1);
                    cymbalFilter1.connect(cymbalFilter2);
                    cymbalFilter2.connect(cymbalGain);
                    cymbalGain.connect(masterGain);
                    
                    cymbalNoise.start(now);
                    break;
                    
                case 'rim':
                    const rimOsc = audioContext.createOscillator();
                    const rimGain = audioContext.createGain();
                    const rimFilter = audioContext.createBiquadFilter();
                    
                    rimOsc.type = 'square';
                    rimOsc.frequency.value = 1000;
                    
                    rimFilter.type = 'highpass';
                    rimFilter.frequency.value = 2000;
                    
                    rimGain.gain.setValueAtTime(0.5, now);
                    rimGain.gain.exponentialRampToValueAtTime(0.01, now + 0.03);
                    
                    rimOsc.connect(rimFilter);
                    rimFilter.connect(rimGain);
                    rimGain.connect(masterGain);
                    
                    rimOsc.start(now);
                    rimOsc.stop(now + 0.03);
                    break;
            }
            
            if (!skipRecording && (isRecording || isOverdub)) {
                loopSlots[activeSlot].loop.push({
                    type: 'drum',
                    sound: type,
                    time: audioContext.currentTime - recordingStart
                });
            }
        }

        function playNote(freq, skipRecording = false) {
            if (!audioContext) {
                initSystem();
                setTimeout(() => playNote(freq), 100);
                return;
            }
            
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            const noteEntry = Object.entries(notes).find(([key, f]) => f === freq);
            if (noteEntry) {
                const [noteName] = noteEntry;
                const keyEl = document.querySelector(`[data-note="${noteName}"]`);
                if (keyEl) {
                    keyEl.classList.add('active');
                    setTimeout(() => keyEl.classList.remove('active'), 200);
                }
            }
            
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            
            const wave = document.getElementById('waveType').value;
            osc.type = wave;
            osc.frequency.setValueAtTime(freq, audioContext.currentTime);
            
            const now = audioContext.currentTime;
            const attack = attackTime / 1000;
            const release = releaseTime / 1000;
            
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.3, now + attack);
            gain.gain.exponentialRampToValueAtTime(0.01, now + release);
            
            osc.connect(gain);
            gain.connect(masterGain);
            
            osc.start();
            osc.stop(audioContext.currentTime + release);
            
            if (!skipRecording && (isRecording || isOverdub)) {
                loopSlots[activeSlot].loop.push({
                    type: 'synth',
                    freq: freq,
                    wave: wave,
                    time: audioContext.currentTime - recordingStart
                });
            }
        }

        document.getElementById('initBtn').addEventListener('click', initSystem);
        document.getElementById('micBtn').addEventListener('click', toggleMic);

        function addTouchClick(element, handler) {
            let touchHandled = false;
            element.addEventListener('touchstart', function(e) {
                e.preventDefault();
                touchHandled = true;
                handler.call(this, e);
            });
            element.addEventListener('click', function(e) {
                if (!touchHandled) {
                    handler.call(this, e);
                }
                touchHandled = false;
            });
        }

        document.querySelectorAll('.pad').forEach(pad => {
            addTouchClick(pad, function() {
                const sound = this.dataset.sound;
                playDrum(sound);
            });
        });

        document.querySelectorAll('.key').forEach(key => {
            addTouchClick(key, function() {
                const note = this.dataset.note;
                playNote(notes[note]);
            });
        });

        const sequencer = document.getElementById('sequencer');
        const drums = ['kick', 'snare', 'hihat', 'clap', 'tom1', 'perc', 'cymbal', 'rim'];
        
        drums.forEach(drum => {
            const stepsContainer = document.querySelector(`.seq-steps[data-drum="${drum}"]`);
            for (let i = 0; i < 16; i++) {
                const step = document.createElement('div');
                step.className = 'step';
                step.dataset.drum = drum;
                step.dataset.index = i;
                addTouchClick(step, function() {
                    sequencerSteps[drum][i] = !sequencerSteps[drum][i];
                    this.classList.toggle('active');
                    updatePatternCount();
                });
                stepsContainer.appendChild(step);
            }
        });

        document.getElementById('playSeq').addEventListener('click', toggleSequencer);

        function toggleSequencer() {
            if (!audioContext) {
                initSystem();
                setTimeout(toggleSequencer, 100);
                return;
            }
            
            if (!isPlaying) {
                isPlaying = true;
                const tempo = parseInt(document.getElementById('tempo').value);
                const interval = (60 / tempo) * 1000 / 4;
                
                document.getElementById('playSeq').textContent = 'stop';
                document.getElementById('playSeq').classList.add('active');
                
                // AUTO-START RECORDING when play is pressed
                if (!isRecording && !isOverdub) {
                    isRecording = true;
                    recordingStart = audioContext.currentTime;
                    loopSlots[activeSlot].loop = [];
                    audioChunks = [];
                    
                    document.getElementById('downloadBtn').style.display = 'none';
                    
                    mediaRecorder = new MediaRecorder(mediaStreamDestination.stream);
                    
                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = async () => {
                        const blob = new Blob(audioChunks, { type: 'audio/webm' });
                        loopSlots[activeSlot].audioBlob = blob;
                        
                        try {
                            const arrayBuffer = await blob.arrayBuffer();
                            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                            loopSlots[activeSlot].audioBuffer = audioBuffer;
                            loopSlots[activeSlot].duration = audioBuffer.duration;
                        } catch (error) {
                            console.error('Error decoding audio:', error);
                        }
                        
                        updateSlotUI();
                        document.getElementById('downloadBtn').style.display = 'block';
                    };
                    
                    mediaRecorder.start();
                    
                    document.getElementById('recordBtn').textContent = 'recording...';
                    document.getElementById('recordBtn').classList.add('active');
                    document.getElementById('recStatus').textContent = 'on';
                }
                
                sequencerInterval = setInterval(() => {
                    const steps = document.querySelectorAll('.step');
                    steps.forEach(s => s.classList.remove('playing'));
                    
                    const currentSteps = document.querySelectorAll(`.step[data-index="${currentStep}"]`);
                    currentSteps.forEach(s => s.classList.add('playing'));
                    
                    drums.forEach(drum => {
                        if (sequencerSteps[drum][currentStep]) {
                            playDrum(drum);
                        }
                    });
                    
                    currentStep = (currentStep + 1) % 16;
                }, interval);
            } else {
                stopSequencer();
            }
        }

        function stopSequencer(shouldStopRecording = true) {
            clearInterval(sequencerInterval);
            isPlaying = false;
            currentStep = 0;
            document.querySelectorAll('.step').forEach(s => s.classList.remove('playing'));
            document.getElementById('playSeq').textContent = 'play+rec';
            document.getElementById('playSeq').classList.remove('active');
            
            // AUTO-STOP RECORDING when sequencer stops (unless it's just a tempo change)
            if (shouldStopRecording && isRecording) {
                isRecording = false;
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                }
                document.getElementById('recordBtn').textContent = 'rec manual';
                document.getElementById('recordBtn').classList.remove('active');
                document.getElementById('recStatus').textContent = 'off';
            }
        }

        document.getElementById('clearSeq').addEventListener('click', () => {
            drums.forEach(drum => {
                sequencerSteps[drum] = Array(16).fill(false);
            });
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            updatePatternCount();
        });

        document.getElementById('recordBtn').addEventListener('click', () => {
            if (!audioContext) {
                initSystem();
                setTimeout(() => document.getElementById('recordBtn').click(), 100);
                return;
            }
            
            if (!isRecording) {
                isRecording = true;
                isOverdub = false;
                recordingStart = audioContext.currentTime;
                loopSlots[activeSlot].loop = [];
                audioChunks = [];
                
                document.getElementById('downloadBtn').style.display = 'none';
                
                mediaRecorder = new MediaRecorder(mediaStreamDestination.stream);
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    loopSlots[activeSlot].audioBlob = blob;
                    
                    try {
                        const arrayBuffer = await blob.arrayBuffer();
                        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                        loopSlots[activeSlot].audioBuffer = audioBuffer;
                        loopSlots[activeSlot].duration = audioBuffer.duration;
                    } catch (error) {
                        console.error('Error decoding audio:', error);
                    }
                    
                    updateSlotUI();
                    document.getElementById('downloadBtn').style.display = 'block';
                };
                
                mediaRecorder.start();
                
                document.getElementById('recordBtn').textContent = 'recording...';
                document.getElementById('recordBtn').classList.add('active');
                document.getElementById('recStatus').textContent = 'on';
            } else {
                isRecording = false;
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                }
                document.getElementById('recordBtn').textContent = 'rec manual';
                document.getElementById('recordBtn').classList.remove('active');
                document.getElementById('recStatus').textContent = 'off';
            }
        });

        document.getElementById('overdubBtn').addEventListener('click', () => {
            if (!audioContext) {
                initSystem();
                setTimeout(() => document.getElementById('overdubBtn').click(), 100);
                return;
            }
            
            if (!isOverdub && !isRecording) {
                isOverdub = true;
                recordingStart = audioContext.currentTime;
                audioChunks = [];
                
                document.getElementById('downloadBtn').style.display = 'none';
                
                mediaRecorder = new MediaRecorder(mediaStreamDestination.stream);
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    loopSlots[activeSlot].audioBlob = blob;
                    
                    try {
                        const arrayBuffer = await blob.arrayBuffer();
                        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                        loopSlots[activeSlot].audioBuffer = audioBuffer;
                        loopSlots[activeSlot].duration = audioBuffer.duration;
                    } catch (error) {
                        console.error('Error decoding audio:', error);
                    }
                    
                    updateSlotUI();
                    document.getElementById('downloadBtn').style.display = 'block';
                };
                
                mediaRecorder.start();
                
                document.getElementById('overdubBtn').textContent = 'layering...';
                document.getElementById('overdubBtn').classList.add('active');
                document.getElementById('recStatus').textContent = 'overdub';
            } else if (isOverdub) {
                isOverdub = false;
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                }
                document.getElementById('overdubBtn').textContent = 'add layer';
                document.getElementById('overdubBtn').classList.remove('active');
                document.getElementById('recStatus').textContent = 'off';
            }
        });

        document.getElementById('playLoopBtn').addEventListener('click', () => {
            const slot = loopSlots[activeSlot];
            
            if (!audioContext) {
                initSystem();
                setTimeout(() => document.getElementById('playLoopBtn').click(), 100);
                return;
            }
            
            if (slot.audioBuffer) {
                const source = audioContext.createBufferSource();
                source.buffer = slot.audioBuffer;
                source.connect(masterGain);
                source.start(0);
            }
            
            if (slot.loop.length > 0) {
                slot.loop.forEach(event => {
                    setTimeout(() => {
                        if (event.type === 'drum') {
                            playDrum(event.sound, true);
                        } else if (event.type === 'synth') {
                            playNote(event.freq, true);
                        }
                    }, event.time * 1000);
                });
            }
        });

        document.getElementById('playAllBtn').addEventListener('click', () => {
            if (!audioContext) {
                initSystem();
                setTimeout(() => document.getElementById('playAllBtn').click(), 100);
                return;
            }
            
            Object.keys(loopSlots).forEach(slotKey => {
                const slot = loopSlots[slotKey];
                
                if (slot.audioBuffer) {
                    const source = audioContext.createBufferSource();
                    source.buffer = slot.audioBuffer;
                    source.connect(masterGain);
                    source.start(0);
                }
                
                if (slot.loop.length > 0) {
                    slot.loop.forEach(event => {
                        setTimeout(() => {
                            if (event.type === 'drum') {
                                playDrum(event.sound, true);
                            } else if (event.type === 'synth') {
                                playNote(event.freq, true);
                            }
                        }, event.time * 1000);
                    });
                }
            });
        });

        document.getElementById('clearLoopBtn').addEventListener('click', () => {
            loopSlots[activeSlot].loop = [];
            loopSlots[activeSlot].audioBlob = null;
            loopSlots[activeSlot].audioBuffer = null;
            loopSlots[activeSlot].duration = 0;
            updateSlotUI();
            document.getElementById('downloadBtn').style.display = 'none';
        });

        document.getElementById('downloadBtn').addEventListener('click', () => {
            const blob = loopSlots[activeSlot].audioBlob;
            if (!blob) return;
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            a.download = `playground-mk1-slot-${activeSlot}-${timestamp}.webm`;
            document.body.appendChild(a);
            a.click();
            
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        });

        document.querySelectorAll('.slot-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.slot-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                activeSlot = this.dataset.slot;
                updateSlotUI();
            });
        });

        function updateSlotUI() {
            const slot = loopSlots[activeSlot];
            
            let infoText;
            if (slot.audioBuffer) {
                const duration = slot.duration.toFixed(1);
                infoText = `slot ${activeSlot} · ${duration}s recorded`;
            } else if (slot.loop.length > 0) {
                infoText = `slot ${activeSlot} · ${slot.loop.length} events`;
            } else {
                infoText = `slot ${activeSlot} · empty`;
            }
            document.getElementById('slotInfo').textContent = infoText;
            
            document.querySelectorAll('.slot-btn').forEach(btn => {
                const slotKey = btn.dataset.slot;
                const slotHasContent = loopSlots[slotKey].loop.length > 0 || loopSlots[slotKey].audioBuffer !== null;
                if (slotHasContent) {
                    btn.classList.add('has-content');
                } else {
                    btn.classList.remove('has-content');
                }
            });
            
            if (slot.audioBlob) {
                document.getElementById('downloadBtn').style.display = 'block';
            } else {
                document.getElementById('downloadBtn').style.display = 'none';
            }
        }

        document.getElementById('masterVol').addEventListener('input', function() {
            if (masterGain) masterGain.gain.value = this.value / 100;
            document.getElementById('masterVolVal').textContent = this.value + '%';
        });

        document.getElementById('attack').addEventListener('input', function() {
            attackTime = this.value;
            document.getElementById('attackVal').textContent = this.value + 'ms';
        });

        document.getElementById('release').addEventListener('input', function() {
            releaseTime = this.value;
            document.getElementById('releaseVal').textContent = this.value + 'ms';
        });

        document.getElementById('tempo').addEventListener('input', function() {
            document.getElementById('tempoVal').textContent = this.value;
            document.getElementById('tempoStatus').textContent = this.value;
            if (isPlaying) {
                stopSequencer(false); // Don't stop recording, just restart sequencer with new tempo
                setTimeout(() => toggleSequencer(), 50);
            }
        });

        document.getElementById('reverb').addEventListener('input', function() {
            const value = this.value / 100;
            document.getElementById('reverbVal').textContent = this.value + '%';
            if (window.reverbMix) {
                window.reverbMix.gain.value = value;
            }
        });

        document.getElementById('delay').addEventListener('input', function() {
            const value = this.value / 100;
            document.getElementById('delayVal').textContent = this.value + '%';
            if (window.delayMix) {
                window.delayMix.gain.value = value;
            }
        });

        document.getElementById('filter').addEventListener('input', function() {
            const value = parseInt(this.value);
            document.getElementById('filterVal').textContent = value + 'Hz';
            if (window.filterNode) {
                window.filterNode.frequency.setValueAtTime(value, audioContext.currentTime);
            }
        });

        const keyMap = {
            '1': 'kick', '2': 'snare', '3': 'hihat', '4': 'clap',
            '5': 'tom1', '6': 'perc', '7': 'cymbal', '8': 'rim',
            'a': 'C4', 'w': 'C#4', 's': 'D4', 'e': 'D#4',
            'd': 'E4', 'f': 'F4', 't': 'F#4', 'g': 'G4',
            'y': 'G#4', 'h': 'A4', 'u': 'A#4', 'j': 'B4', 'k': 'C5'
        };

        document.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            
            if (key === 'enter') {
                initSystem();
                return;
            }
            
            if (key === ' ') {
                e.preventDefault();
                toggleSequencer();
                return;
            }
            
            if (key === 'r') {
                document.getElementById('recordBtn').click();
                return;
            }
            if (key === 'o') {
                document.getElementById('overdubBtn').click();
                return;
            }
            if (key === 'p') {
                document.getElementById('playLoopBtn').click();
                return;
            }
            if (key === 'l') {
                document.getElementById('playAllBtn').click();
                return;
            }
            if (key === 'c') {
                document.getElementById('clearLoopBtn').click();
                return;
            }
            if (key === 'x') {
                document.getElementById('clearSeq').click();
                return;
            }
            if (key === 'v') {
                document.getElementById('downloadBtn').click();
                return;
            }
            if (key === 'm') {
                toggleMic();
                return;
            }
            
            if (key === 'q') {
                document.querySelector('[data-slot="A"]').click();
                return;
            }
            if (key === 'z') {
                document.querySelector('[data-slot="B"]').click();
                return;
            }
            if (key === 'b') {
                document.querySelector('[data-slot="C"]').click();
                return;
            }
            if (key === 'n') {
                document.querySelector('[data-slot="D"]').click();
                return;
            }
            
            if (keyMap[key]) {
                const val = keyMap[key];
                
                if (['kick', 'snare', 'hihat', 'clap', 'tom1', 'perc', 'cymbal', 'rim'].includes(val)) {
                    playDrum(val);
                    const pad = document.querySelector(`[data-sound="${val}"]`);
                    if (pad) {
                        pad.classList.add('active');
                        setTimeout(() => pad.classList.remove('active'), 150);
                    }
                } else {
                    playNote(notes[val]);
                    const keyEl = document.querySelector(`[data-note="${val}"]`);
                    if (keyEl) {
                        keyEl.classList.add('active');
                        setTimeout(() => keyEl.classList.remove('active'), 200);
                    }
                }
            }
        });

        function drawViz() {
            if (!isActive || !analyser) {
                requestAnimationFrame(drawViz);
                return;
            }
            
            requestAnimationFrame(drawViz);
            
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteTimeDomainData(dataArray);
            
            // Get colors from CSS variables
            const bgColor = getComputedStyle(document.documentElement).getPropertyValue('--viz-bg').trim();
            const lineColor = getComputedStyle(document.documentElement).getPropertyValue('--viz-line').trim();
            
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.lineWidth = 2;
            ctx.strokeStyle = lineColor;
            ctx.beginPath();
            
            const sliceWidth = canvas.width / bufferLength;
            let x = 0;
            
            for (let i = 0; i < bufferLength; i++) {
                const v = dataArray[i] / 128.0;
                const y = v * canvas.height / 2;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                
                x += sliceWidth;
            }
            
            ctx.lineTo(canvas.width, canvas.height / 2);
            ctx.stroke();
        }

        let resizeTimeout;
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }
        
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(resizeCanvas, 100);
        });
        
        window.addEventListener('orientationchange', () => {
            setTimeout(resizeCanvas, 300);
        });

        function updateTimestamp() {
            const now = new Date();
            const date = now.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
            const time = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('timestamp').textContent = `${date} — ${time}`;
        }
        
        updateTimestamp();
        setInterval(updateTimestamp, 1000);

        function updatePatternCount() {
            let totalActive = 0;
            drums.forEach(drum => {
                const activeSteps = sequencerSteps[drum].filter(step => step).length;
                totalActive += activeSteps;
            });
            document.getElementById('patternCount').textContent = totalActive > 0 ? 1 : 0;
        }

        document.getElementById('loadDemoBtn').addEventListener('click', () => {
            if (!audioContext) {
                initSystem();
            }
            
            Object.keys(loopSlots).forEach(key => {
                loopSlots[key].loop = [];
                loopSlots[key].audioBlob = null;
                loopSlots[key].audioBuffer = null;
                loopSlots[key].duration = 0;
            });
            drums.forEach(drum => {
                sequencerSteps[drum] = Array(16).fill(false);
            });
            
            sequencerSteps.kick[0] = true;
            sequencerSteps.kick[4] = true;
            sequencerSteps.kick[8] = true;
            sequencerSteps.kick[12] = true;
            
            sequencerSteps.snare[4] = true;
            sequencerSteps.snare[12] = true;
            
            for (let i = 0; i < 16; i += 2) {
                sequencerSteps.hihat[i] = true;
            }
            
            sequencerSteps.clap[4] = true;
            sequencerSteps.clap[12] = true;
            
            document.querySelectorAll('.step').forEach(step => {
                const drum = step.dataset.drum;
                const index = parseInt(step.dataset.index);
                if (sequencerSteps[drum][index]) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });
            
            activeSlot = 'A';
            document.querySelectorAll('.slot-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('[data-slot="A"]').classList.add('active');
            
            loopSlots.A.loop = [
                { type: 'synth', freq: notes.C4, wave: 'sine', time: 0 },
                { type: 'synth', freq: notes.E4, wave: 'sine', time: 0.5 },
                { type: 'synth', freq: notes.G4, wave: 'sine', time: 1.0 },
                { type: 'synth', freq: notes.C5, wave: 'sine', time: 1.5 },
                { type: 'synth', freq: notes.G4, wave: 'sine', time: 2.0 },
                { type: 'synth', freq: notes.E4, wave: 'sine', time: 2.5 },
                { type: 'synth', freq: notes.C4, wave: 'sine', time: 3.0 }
            ];
            
            document.getElementById('tempo').value = 120;
            document.getElementById('tempoVal').textContent = '120';
            document.getElementById('tempoStatus').textContent = '120';
            document.getElementById('waveType').value = 'sine';
            
            updatePatternCount();
            updateSlotUI();
            
            const heroP = document.querySelector('.hero p');
            const originalText = heroP.textContent;
            heroP.textContent = 'demo loaded! hit space to hear it';
            setTimeout(() => {
                heroP.textContent = originalText;
            }, 4000);
        });

        document.getElementById('clearAllBtn').addEventListener('click', () => {
            if (isMicActive) {
                toggleMic();
            }
            
            Object.keys(loopSlots).forEach(key => {
                loopSlots[key].loop = [];
                loopSlots[key].audioBlob = null;
                loopSlots[key].audioBuffer = null;
                loopSlots[key].duration = 0;
                loopSlots[key].isPlaying = false;
            });
            
            drums.forEach(drum => {
                sequencerSteps[drum] = Array(16).fill(false);
            });
            
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            
            if (isPlaying) {
                stopSequencer();
            }
            
            activeSlot = 'A';
            document.querySelectorAll('.slot-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('[data-slot="A"]').classList.add('active');
            
            document.getElementById('tempo').value = 120;
            document.getElementById('tempoVal').textContent = '120';
            document.getElementById('tempoStatus').textContent = '120';
            
            document.getElementById('waveType').value = 'sine';
            
            document.getElementById('attack').value = 10;
            document.getElementById('attackVal').textContent = '10ms';
            
            document.getElementById('release').value = 300;
            document.getElementById('releaseVal').textContent = '300ms';
            
            document.getElementById('reverb').value = 0;
            document.getElementById('reverbVal').textContent = '0%';
            if (window.reverbMix) window.reverbMix.gain.value = 0;
            
            document.getElementById('delay').value = 0;
            document.getElementById('delayVal').textContent = '0%';
            if (window.delayMix) window.delayMix.gain.value = 0;
            
            document.getElementById('filter').value = 10000;
            document.getElementById('filterVal').textContent = '10000Hz';
            if (window.filterNode) window.filterNode.frequency.value = 10000;
            
            document.getElementById('masterVol').value = 70;
            document.getElementById('masterVolVal').textContent = '70%';
            if (masterGain) masterGain.gain.value = 0.7;
            
            document.getElementById('downloadBtn').style.display = 'none';
            
            updatePatternCount();
            updateSlotUI();
            
            const heroP = document.querySelector('.hero p');
            const originalText = heroP.textContent;
            heroP.textContent = 'all clear! start creating';
            setTimeout(() => {
                heroP.textContent = originalText;
            }, 3000);
        });

        // Theme Toggle - Always starts in light mode
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;

        themeToggle.addEventListener('click', () => {
            html.classList.toggle('dark-mode');
        });
    </script>
</body>
</html>
